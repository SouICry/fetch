<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>


    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css">

    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/js/materialize.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">

    <script src="js/underscore.js"></script>
    <script src="js/loader.js"></script>

    <!-- changes background every 30 seconds -->
    <script src="js/_backgroundImage.js"></script>

</head>
<body style="overflow: hidden; position: relative;">
<div id="notifications">

</div>
<div id="chats">

</div>
<div id="User">
    <div class="container">
        <div class="row">
            <div id="Glyph" class="col-xs-3">
                <div id="open-menu-drawer"><span class="glyphicon glyphicon-menu-hamburger"></span></div>
            </div>
            <div id="Fetch" class=" text-center col-xs-6">
                <div id="title">Fetch</div>
            </div>
            <div class="col-xs-3"></div>
        </div>
    </div>
</div>

<div id="page-content" style="overflow-x: visible">

</div>

<div id="menu-drawer" class="cd-panel from-left" style="z-index: 3000">
    <div class="cd-panel-container">
        <div id="panel-Header" class="">
            <div class="container-name">
                <div class="div1" onclick="goToPage('_accSetting')"><img class="img-circle" id="index-image-user"
                                                                         src="placeholder/person4.png"></div>
                <div class="div2" id="index_user-name">hell</div>
                <div>
                    <span id="toggling">Shopper</span>
                    <span id="toggleButton" onclick="toggles();" class="toggle-button">
                        <button></button>
                    </span>
                </div>
            </div>
            <!--<div id="close-menu" class="cd-panel-close">Close</div>-->
        </div>
        <div class="cd-panel-content">
            <div id="Butt">

            </div>
        </div>
    </div>
</div>

<!-- Camera -->
<select class="hidden" id="videoSource"></select>
<script src="js/camera.js"></script>
<!-- -->

<script src="js/pages.js"></script>
<div id="prerender"></div>
<script>
    function goToPage(id, noPrevious) {
        if (id.length) {
            if (arguments.length > 1) {
                loader.setCurrentPage(id, true);
            }
            else {
                loader.setCurrentPage(id, false);
            }
        }
    }

    function goToPreviousPage() {
        goToPage(loader.previousPage, true);
    }

    function createNotification(text, page, icon) {
        var onClick = "loader.closeNotification('" + page + "', this);";
        return '<div class="notification-inner" data-changePage="true" onclick="' + onClick + '"><div class="icon"><i class="material-icons">'
                + icon + '</i></div><div class="text">' + text + '</div></div>';
    }

    var ticketPrototype = {
        ticket: {
            id: "",
            state: "", //pending, accepted, shopped, delivered, cancelled
            store: "",
            user: {
                id: "",
                contact: "",
                rating: "",
                address: ""
            },
            driver: {
                id: "",
                rating: ""
            },
            list: [],
            options: {},
            checkoff: []
        }
    };


    var chatProto = {
        username: {
            messages: [""],
            isOpen: false,
            name: ""
        },
        username1: []
    }
    var loader = {
        activeCyclesLeft: 20,
        isDriver: false,
        isLoggedIn: false,
        userId: "",
        pageCount: 0,
        previousPage: "_homePage",
        currentPage: "_homePage",
        notificationCount: 0,
        chatCount: 0,
        chat: {},
        notificationSound: new Audio('/notify.mp3'),
        appendChat: function (id, arr, name) {
            if (!loader.chat.hasOwnProperty(id)) {
                loader.chat[id] = {
                    messages: [],
                    isOpen: false,
                    name: name
                };
                var u = loader.chat[id];
//                for (var i = 1; i < arr.length; i++) {
//                    u.messages.push(arr[i]);
//                }
//                loader.openChat(id, arr[0])
            }
            else if (!loader.chat[id].isOpen) {
                var u = loader.chat[id];
                for (var i = 0; i < arr.length; i++) {
                    u.messages.push(arr[i]);
                }
                loader.openChat(id, u.name);
            }
            else {
                var u = loader.chat[id];
                var chat = $(document.getElementById('chatForm' + id).parentNode.parentNode).find('.window');
                for (var i = 0; i < arr.length; i++) {
                    u.messages.push(arr[i]);
                    console.log(arr[i]);
                    chat.append(arr[i]);
                }

                $('#chatWindow' + id).scrollTop(100000);
            }
            loader.notificationSound.play();
        },
        openChat: function (id, name) {
            if (!loader.chat.hasOwnProperty(id)) {
                loader.chat[id] = {
                    messages: [],
                    isOpen: false,
                    name: name
                };
            }

            var c = loader.chat[id];
            if (!c.isOpen) {
                c.isOpen = true;
                //TODO: otherwise open and load existing array
                var e = document.createElement('div');
                e.className = "chat";
                var min = 'onclick="loader.minimizeChat(this.parentNode.parentNode);"';
                var onClick = "loader.closeChat(this.parentNode.parentNode);";
                e.innerHTML = '<div class="chat-head"  data-closed="false" >' +
                        '<div class="chat-profile" ' + min + '>' + '<span class="glyphicon medium glyphicon-user"></span>' + '</div>' +
                        '<div class="chat-name" ' + min + '>' + name + '</div>' +
                        '<div class="chat-close" onclick="' + onClick + '"><span class="glyphicon medium glyphicon-remove"></span></div></div>' +
                        '<div class="window" id="chatWindow' + id + '"></div>' +
                        '<div class="input">' +
                        '<div class="photo"><span class="glyphicon medium glyphicon-picture"></span></div>' +
                        '<form class="chatForm" id="chatForm' + id + '"  data-userid="' + id + '">' +
                        '<input autocomplete="off" name="message" type="text" id="enter_price" placeholder="Enter a message...">' +
                        '</form></div>';

                $(e).find('.chatForm').submit(function (event) {
                    event.preventDefault();

                    var input = $(this).find('input');
                    var message = $(input).val();
                    if (message.length > 0) {

                        var parent = $(this).parent();
                        var content = '<div class="ours"><div>' + message + '</div></div>';
                        $(parent).parent().find('.window').append(content);
                        $.ajax({
                            type: "POST",
                            url: "/chat",
                            contentType: "application/json",
                            dataType: "json",
                            data: JSON.stringify({
                                userIdToChat: $(this).data('userid'),
                                message: message
                            })
                        });
                        c.messages.push(content);
                        test = w;
                        $('#chatWindow' + id).scrollTop(100000);
                        $(input).val("");
                    }
                    return false;
                });


                var w = $(e).find('.window');
                var m = c.messages;
                for (var i = 0; i < m.length; i++) {
                    $(w).append(m[i]);
                }

                $('#chats').append(e);
                $('#chatWindow' + id).scrollTop(100000);
            }

        },
        minimizeChat: function (parent) {
            $(parent).toggleClass("min");
        },
        closeChat: function (parent) {
            var id = $(parent).find('.chatForm').data('userid');
            loader.chat[id].isOpen = false;
            $(parent).remove();
        },
        currentPageObject: {
            getData: null,
            loadData: null,
            data: null
        },
        setActive: function () {
            loader.activeCyclesLeft = 20;
        },
        goToPage(id){
            //Only move if given a string with an actual value
            if (id.length) {
                var item = $('#' + id);
                if (item) {
                    $("#page-content").css('transform',
                            'translate(-' + $(item).data("x") * 100 + '%, -' + $(item).data("y") * 100 + '%)')
                }
            }
        },
        setCurrentPage: function (page, noPrevious) {
            if (loader.currentPage != page) {
                if (loader.hasOwnProperty(loader.currentPage)) {
                    if (loader[loader.currentPage].hasOwnProperty("onPageLeave")) {
                        loader[loader.currentPage].onPageLeave();
                    }
                }
                if (loader.hasOwnProperty(page)) {

                    if (loader[page].hasOwnProperty("onPageLoad")) {
                        loader[page].onPageLoad();
                    }
                }
                loader.previousPage = loader.currentPage;
                loader.currentPage = page;
                $.ajax({
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    url: "/changePage",
                    data: JSON.stringify({
                        newPage: page
                    })
                });
                loader.goToPage(page);
            }
        },
        updateShopping: function () {

            $.ajax({
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                url: "/_shopping",
                data: JSON.stringify({
                    shoppingVersion: loader._shopping.version,
                    list: loader._shopping.getData(),
                    checkoutVersion: loader._checkout.version,
                    checkout: loader._checkout.getData()
                }),
                success: function (data) {
                    if (data.list) {
                        loader._shopping.loadData(data.list);
                        loader._shopping.version = data.shoppingVersion;
                        //loader._shopping.version = data.version;
                    }
                    if (data.checkout) {
                        loader._checkout.loadData(data.checkout);
                        loader._checkout.version = data.checkoutVersion;
                    }
                }
            });
        },

        currentPageChanged: null,
        addNotification: function (notification) {
            var e = document.createElement('div');
            e.className = "notification";
            e.innerHTML = notification;
            document.getElementById("notifications").appendChild(e);
            setTimeout(function () {
                $(e).css("transform", "translateX(-400px)")
                loader.notificationSound.play();
            }, 100);
            setTimeout(function () {
                e.firstChild.dataset.changepage = "false";
                $(e).children().trigger("click");
            }, 10000);
        },

        closeNotification: function (page, element) {

            var p = element.parentNode;
            p.style.transform = "translateX(0)";
            if (element.dataset.changepage == "true") {
                goToPage(page);
            }
            setTimeout(function () {
                p.parentNode.removeChild(p);
            }, 600);
        },
        //set to run every second elsewhere
        getUpdates: function () {

            //Only update if not active
            if (loader.isLoggedIn && loader.userId.length > 1) {
                //keep updating no matter what
                if (loader.currentPage == "_shopping" || loader.currentPage == "_checkout") {
                    loader.updateShopping();
                }
                if (loader.activeCyclesLeft > 0) {
                    loader.activeCyclesLeft--;
                }

                //Get all chat lengths
                var chats = {};
                var c = loader.chat;
                for (var user in c) {
                    chats[user] = c[user].messages.length;
                }


                $.ajax({
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    data: JSON.stringify({
                        chat: chats,
                        isInactive: loader.activeCyclesLeft <= 0,
                        notification: loader.notificationCount
                    }),
                    url: "/getUpdates",
                    success: function (data) {
                        //Notifications
                        if (data.notification != null) {
                            loader.notificationCount += data.notification.length;
                            data.notification.forEach(loader.addNotification);
                        }
                        var c = data.chat;
                        for (var user in c) {
                            loader.appendChat(user, c[user], c[0]); //If new, first element in array should be username
                        }

                        if (data.isInactive) {
                            loader.ticketId = data.ticketId;
                            if (!data.isLoggedIn) {
                                loader.logout();
                                return;
                            }
                            if (data.isDriver != loader.isDriver) {
                                if (data.isDriver) {
                                    loader.switchToDriver();
                                    return;
                                }
                                else {
                                    loader.switchToShopper();
                                    return;
                                }
                            }
                            if (data.currentPage != loader.currentPage) {
                                goToPage(data.currentPage)
                            }
                        }
                    }
                });

            }
        },
        login: function (data) { //Called after successful login, passing the returned data
            console.log("login");
            console.log(data);

            var d = new Date();
            d.setTime(d.getTime() + (1000 * 24 * 60 * 60 * 1000));
            document.cookie = "user=" + data.userId + ";expires=" + d.toUTCString();
            console.log(data.isLoggedIn);
            if (!data.isLoggedIn) {
                loader.userId = data.userId;
                loader.isLoggedIn = true;
                loader.isDriver = false;
                loader.ticketId = "";
                //goToPage("_homePage");
                goToPage(loader.previousPage);
            }
            else {
                loader.userId = data.userId;
                loader.isLoggedIn = true;
                loader.isDriver = data.isDriver;
                loader.ticketId = data.ticketId;

                switch (data.currentPage) {
                    case '_driverList':
                    case "_receiptPictureEnterPrice":
                    case "_confirmCompletion":
                        goToPage("_yourDeliveries");
                        break;
                    case "_viewTicket":
                        goToPage("_tickets");
                        break;
                    case "_shoppingStatus":
                    case "_cancelTicket":
                    case "_confirmTicket":
                        goToPage("_history");
                        break;
                    default:
                        goToPage(data.currentPage);
                }

            }

            window.setInterval(loader.getUpdates, 501);


        },
        logout: function () {
            document.cookie = "user=" + loader.userId + ";expires=" + new Date(0).toUTCString();
            $.ajax({
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                url: "/logout"
            });
            window.location.reload();
        },
        switchToDriver: function () {
            loader.isDriver = true;
            $.ajax({
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                url: "/switchRole",
                data: JSON.stringify({
                    isDriver: true
                })
            });
            //UI changes for menu bar
            goToPage("_yourDeliveries", true);
        },
        switchToShopper: function () {
            loader.isDriver = false;
            $.ajax({
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                url: "/switchRole",
                data: JSON.stringify({
                    isDriver: false
                })
            });
            //UI changes for menu bar
            goToPage("_history", true);
        }
    };
    //loader.currentPageChanged = _.throttle(loader.sendData, 501);


    $(document).ready(function () {
        $(document).on('click mousemove focus keypress', loader.setActive);

        pageInit();
        for (var j = 0; j < allPages.length; j++) {
            $('#page-content').append('<div id="section-' + j + '"></div>');
            for (var i = 0; i < allPages[j].length; i++) {
                var whichid = allPages[j][i];
                loadPage(whichid, j, i);
                var clickVal = "onclick=\"goToPage('" + whichid + "');\"";
                $("#Butt").append("<div " + clickVal + " >" + whichid + "</div>");
            }
        }

        loadPage("payment", 0, 0);
    });

    function pageInit() {
        if (document.cookie.length > 5) {
            loader.userId = document.cookie.substring(5);
            $.ajax({
                type: "POST",
                url: "/init",
                data: {
                    userId: loader.userId
                },
                success: function (data) {
                    //If invalid, clear cookie and reload
                    if (data.userId == "") {
                        document.cookie = "user=" + data.userId + ";expires=" + new Date(0).toUTCString();
                        window.location.reload();
                    }
                    console.log("init exists");
                    console.log(data);
                    if (!data.isLoggedIn) {
                        loader.userId = data.userId;
                        loader.isLoggedIn = true;
                        loader.isDriver = false;
                        loader.ticketId = "";
                        loader.currentPage = "_homePage";
                    }
                    else {
                        if(UrlExists('images/profiles/' + data.userId + '.png'))
                            document.getElementById("index-image-user").src = 'images/profiles/' + data.userId + '.png';
                        else
                            document.getElementById("index-image-user").src = 'placeholder/person4.png';
                        document.getElementById("index_user-name").innerHTML = data.userId;

                        loader.userId = data.userId;
                        loader.isLoggedIn = true;
                        loader.isDriver = data.isDriver;
                        loader.ticketId = data.ticketId;
                        if (window.location.hash.length > 5) {
                            //submit or cancel ticket
                            goToPage(window.location.hash.substring(1));
                            window.location.hash = "";
                        }
                        else {
                            switch (data.currentPage) {
                                case '_driverList':
                                case "_receiptPictureEnterPrice":
                                case "_confirmCompletion":
                                    goToPage("_yourDeliveries");
                                    break;
                                case "_viewTicket":
                                    goToPage("_tickets");
                                    break;
                                case "_shoppingStatus":
                                case "_cancelTicket":
                                case "_confirmTicket":
                                    goToPage("_history");
                                    break;
                                default:
                                    goToPage(data.currentPage);
                            }
                        }
                    }
                    window.setInterval(loader.getUpdates, 501);
                }
            });
        }
        else {
            loader.userId = "";
            loader.isLoggedIn = false;
            loader.isDriver = false;
            loader.ticketId = "";
            loader.currentPage = "_homePage";
        }
    }

    function loadPage(pageName, row, column) {
        $.ajax({
            type: "POST",
            url: "/loadPage",
            data: {name: pageName},
            async: false,
            success: function (data) {
                $('#section-' + row).append("<div><div id='" + pageName +
                        "' data-x='" + column + "' data-y='" + row + "'>" + data + "</div></div>");
            }
        });
    }


    $(document).ready(function ($) {
        var menuIsVisible = false;
        var menuDrawer = $('#menu-drawer');
        $('#open-menu-drawer').on('click', function () {
            if (!menuIsVisible) {
                $(menuDrawer).addClass('is-visible');
                menuIsVisible = true;
                event.stopPropagation();
            }
        });

        $("#Butt, #User, #page-content").on('click', function (event) {
            if (menuIsVisible) {
                menuIsVisible = false;
                $(menuDrawer).removeClass('is-visible');
            }
        });
    });
</script>
<script type="text/javascript" src="/js/_index.js"></script>

</body>
</html>