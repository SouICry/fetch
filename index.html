<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <!--<link rel="stylesheet" href="/css/normalize.css">-->
    <!--<link rel="stylesheet"-->
    <!--href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/4.0.1/bootstrap-material-design.min.css">css-->
    <link rel="stylesheet" href="/css/style.css">
    <script src="js/underscore.js"></script>
    <script src="js/loader.js"></script>
</head>
<body style="overflow: hidden; position: relative;">

<div id="User">
    <div class="container">
        <div class="row">
            <div class="col-xs-3"></div>
            <div id="Fetch" class="col-xs-6" style="text-align:center">
                <div id="title">Fetch</div>
            </div>

            <div id="Glyph" class="col-xs-3">
                <div id="open-menu-drawer" class="btn btn-lg pull-right"><span
                        class="glyphicon glyphicon-user large"></span></div>
            </div>
        </div>
    </div>
</div>

<div id="page-content" style="overflow-x: visible">

</div>

<div id="menu-drawer" class="cd-panel from-right" style="z-index: 3000">
    <div class="cd-panel-container">
        <header id="panel-Header" class="">
            <h1 id="index_user-name">hellp</h1>
            <div id="close-menu" class="cd-panel-close">Close</div>
        </header>
        <div class="cd-panel-content">
            <div id="Butt">
                <div class='panel-divs' id='index-Home' >

                    <span id="toggling">Shopper</span>
                    <span id="toggleButton" onclick="toggles();"class="toggle-button">
                        <button></button>
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="js/pages.js"></script>

<script>
    function goToPage(id, noPrevious) {
        if (id.length) {
            if (arguments.length > 1) {
                //loader.setCurrentPage(id, true);
            }
            else {
                //loader.setCurrentPage(id, false);
            }
            loader.goToPage(id);
            /*Temporary*/
        }
    }
    function goToPreviousPage() {
        goToPage(loader.previousPage, true);
    }
    /*
     TODO:
     Each page MUST specify function to send/received data, or null
     Each page will call goToPage onclick to go to the correct page
     */
    var ticketPrototype = {
        ticket: {
            id: "",
            state: "", //pending, accepted, shopped, delivered, cancelled
            store: "",
            user: {
                id: "",
                contact: "",
                rating: "",
                address: ""
            },
            driver: {
                id: "",
                rating: ""
            },
            list: [],
            options: {},
            checkoff: []
        }
    };
    var loader = {
        isDriver: false,
        isLoggedIn: false,
        userId: "",
        pageCount: 0,
        previousPage: "_homePage",
        currentPage: "_homePage",
        currentPageObject: {
            getData: null,
            loadData: null,
            data: null
        },
        goToPage(id){
            //Only move if given a string with an actual value
            if (id.length) {
                var item = $('#' + id);
                if (item) {
                    $("#page-content").css('transform',
                            'translate(-' + $(item).data("x") * 100 + '%, -' + $(item).data("y") * 100 + '%)')
                }
            }
        },
        setCurrentPage: function (page, noPrevious) {
            if (loader.currentPage != page) {
                loader.pageCount++;
                var oldPage = loader.currentPage;
                loader.currentPage = page;
                if (loader.currentPageObject.getData != null) {
                    loader.currentPageObject.data = loader.currentPageObject.getData();
                }
                else {
                    loader.currentPageObject.data = null;
                }
                $.ajax({
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    url: "/changePage",
                    data: JSON.stringify({
                        pageCount: loader.pageCount,
                        newPage: page,
                        oldPage: oldPage,
                        oldData: loader.currentPageObject.data
                    }),
                    success: function (newPageData) {
                        console.log(newPageData);
                        loader.goToPage(loader.currentPage);
                        if (noPrevious) {
                            loader.previousPage = loader.currentPage;
                        }
                        else {
                            loader.previousPage = oldPage;
                        }
                        loader.currentPageObject = loader[loader.currentPage];
                        if (loader.currentPageObject.loadData != null) {
                            loader.currentPageObject.loadData(newPageData);
                        }
                    }
                });
            }
        },
        //Saves current active ticket (if any), then fetches new one and loads page data corresponding to ticket status in back end store
        getTicket: function (ticketId) {
            $.ajax({
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                url: "/getTicket",
                data: JSON.stringify({
                    id: ticketId
                }), success: function (state) {
                    if (loader.isDriver) {
                        switch (state) {
                            case "accepted" :
                                goToPage("_driverList");
                                break;
                            case "shopped":
                                goToPage("_completeTicket");
                                break;
                            case "delivered" :
                                goToPage("_delivered");
                        }
                    }
                    else {
                        switch (state) {
                            case "draft" :
                                goToPage("_shopping");
                                break;
                            case "pending":
                                goToPage("_cancelTicket");
                                break;
                            case "shopped":
                                goToPage("_acceptTicket");
                                break;
                        }
                    }
                }
            });
        },
        sendData: function () { //Gets data from page and sends to server for update. Server will send back version num
            if (loader.currentPageObject.getData != null) {
                loader.currentPageObject.data = loader.currentPageObject.getData();
                $.ajax({
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    url: "/sendData",
                    data: JSON.stringify({
                        name: loader.currentPage,
                        data: loader.currentPageObject.data,
                        version: loader.currentPageObject.version
                    }), success: function (resp) {
                        if (loader.currentPageObject.version < resp) {
                            loader.currentPageObject.version = resp;
                        }
                    }
                });
            }
        }
        ,
        loadData: function () { //Gets data from server to load page with
            if (loader.currentPageObject.loadData != null) {
                $.ajax({
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    url: "/loadData",
                    data: JSON.stringify({
                        name: loader.currentPage,
                        version: loader.currentPageObject.version
                    }),
                    success: function (resp) {
                        if (resp != "none") {
                            loader.currentPageObject.data = resp.data;
                            loader.currentPageObject.version = resp.version;
                            loader.currentPageObject.loadData();
                        }
                    }
                });
            }
        }
        ,
        currentPageChanged: null,
        //set to run every second elsewhere
        getUpdates: function () {
            $.ajax({
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                url: "/getUpdates",

                data: JSON.stringify({
                    pageCount: loader.pageCount,
                    page: loader.currentPage
                })
                , success: function (resp) {
                    //Logout if now is logged out
                    if (resp.isLoggedIn != loader.isLoggedIn) {
                        if (!resp.isLoggedIn) {
                            loader.logout();
                            return;
                        }
                    }
                    //Driver change, trigger driver change
                    if (resp.isDriver != loader.isDriver) {
                        if (resp.isDriver) {
                            loader.switchToDriver();
                            return;
                        }
                        else {
                            loader.switchToShopper();
                            return;
                        }
                    }
                    //Change page if page is newer
                    if (resp.pageCount > loader.pageCount) {
                        loader.previousPage = resp.previousPage;
                        loader.currentPage = resp.currentPage;
                        loader.currentPageObject = loader[resp.currentPage];
                        loader.currentPageObject.version = resp.version;
                        if (loader.currentPageObject.loadData != null) {
                            loader.currentPageObject.loadData(resp.data);
                        }
                        loader.goToPage(loader.currentPage);
                    }
                    //Update page if on same page and new version
                    else if (resp.pageCount == loader.pageCount) {
                        if (resp.version > loader.currentPageObject.version) {
                            if (loader.currentPageObject.loadData != null) {
                                loader.currentPageObject.loadData(resp.data);
                            }
                        }
                    }
                    else {
                        //do nothing since this local copy is newer
                    }
                }
            });
        },
        login: function (data) { //Called after successful login, passing the returned data
            document.cookie = "user=" + data.userId + ";expires=" + new Date().setUTCFullYear(2345).toUTCString();
            loader.userId = data.userId;
            //If already logged in, Simply reload page to use init to get the data
            if (data.isLoggedIn) {
                window.location.reload();
            }
            //Otherwise keep as is and go back
            else {
                goToPreviousPage();
            }
        },
        logout: function () {
            document.cookie = "user=" + data.userId + ";expires=" + new Date(0).toUTCString();
            $.ajax({
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                url: "/logout",
                data: JSON.stringify({}),
                success: function () {
                }
            });
            window.location.reload();
        }
        ,
        switchToDriver: function () {
            loader.isDriver = true;
            $.ajax({
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                url: "/switchRole",
                data: JSON.stringify({
                    isDriver: true
                }),
                function(){

                }
            });
            //UI changes for menu bar
            goToPage("_yourDeliveries", true);
        }
        ,
        switchToShopper: function () {
            loader.isDriver = false;
            $.ajax({
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                url: "/switchRole",
                data: JSON.stringify({
                    isDriver: false
                }), function(){

                }
            });
            //UI changes for menu bar
            goToPage("_history", true);
        }
    };
    loader.currentPageChanged = _.throttle(loader.sendData, 500);
    /*
     Each page that needs like sync (edit ticket pages and stateless pages) has:
     data:
     version:
     getData: packages page data.
     loadData: loads data package
     Otherwise it is a missing property; the other pages load data through their own ajax(?)
     */
    function pageInit() {
        if (document.cookie.length > 5) {
            var user = document.cookie;
            loader.userId = user.split(";")[0].substring(5);
        }
        else {
            loader.userId = "";
        }
        $.ajax({
            type: "POST",
            url: "/init",
            data: {
                userId: loader.userId //"" or valid user id string
            },
            success: function (resp) {
                console.log(resp);
                if (resp.isLoggedIn) {
                    loader.isDriver = resp.isDriver;
                    loader.userId = resp.userId;
                    loader.pageCount = resp.pageCount;
                    loader.previousPage = resp.previousPage;
                    loader.currentPage = resp.currentPage;
                    loader.currentPageObject = loader[resp.currentPage];
                    loader.currentPageObject.version = resp.version;
                    if (loader.currentPageObject.loadData != null) {
                        loader.currentPageObject.loadData(resp.data);
                    }
                    loader.goToPage(resp.currentPage);
                }
                else {
                    loader.userId = resp.userId;
                }
                //window.setInterval(loader.getUpdates, 500);
            }
        });
    }
    function loadPage(pageName, row, column) {
        $.ajax({
            type: "POST",
            url: "/loadPage",
            data: {name: pageName},
            async: false,
            success: function (data) {
                $('#section-' + row).append("<div id='" + pageName +
                        "' data-x='" + column + "' data-y='" + row + "'>" + data + "</div>");
            }
        });
    }
    $(document).ready(function () {
        pageInit();
        for (var j = 0; j < allPages.length; j++) {
            $('#page-content').append('<div id="section-' + j + '"></div>');
            for (var i = 0; i < allPages[j].length; i++) {
                var whichid = allPages[j][i];
                loadPage(whichid, j, i);
                var clickVal = "onclick=\"goToPage('" + whichid + "');\"";
                $("#Butt").append("<div " + clickVal + " >" + whichid + "</div>");
            }
        }
    });
    jQuery(document).ready(function ($) {
        $('#open-menu-drawer').on('click', function (event) {
            $('#menu-drawer').addClass('is-visible');
        });
        $('#menu-drawer').on('click', function (event) {
            if ($(event.target).is('.cd-panel') || $(event.target).is('.cd-panel-close')) {
                $('#menu-drawer').removeClass('is-visible');
            }
        });
    });
</script>
<script type="text/javascript" src="/js/_index.js"></script>

</body>
</html>