<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>

    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="/css/normalize.css">
    <!--<link rel="stylesheet"-->
    <!--href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/4.0.1/bootstrap-material-design.min.css">css-->
    <link rel="stylesheet" href="/css/style.css">

    <script src="js/loader.js"></script>
</head>
<body style="overflow: hidden; position: relative;">

<div id="User">
    <div class="container">
        <div class="row">
            <div class="col-xs-3"></div>
            <div id="Fetch" class="col-xs-6" style="text-align:center">
                <div id="title">Fetch</div>
            </div>

            <div id="Glyph" class="col-xs-3">
                <div id="open-menu-drawer" class="btn btn-lg pull-right"><span
                        class="glyphicon glyphicon-user large"></span></div>
            </div>
        </div>
    </div>
</div>

<div id="page-content" style="overflow-x: visible">
    <div id="abovePages" class=""></div>
    <div id="createTicket" class=""></div>
    <!--<div id="acceptTicket" class=""></div>-->
    <div id="confirmTicket" class=""></div>
    <div id="driverFlow" class=""></div>
</div>

<div id="menu-drawer" class="cd-panel from-right" style="z-index: 3000">
    <div class="cd-panel-container">
        <header id="panel-Header" class="">
            <h1 id="index_user-name">hellp</h1>
            <div id="close-menu" class="cd-panel-close">Close</div>
        </header>
        <div class="cd-panel-content">
            <div id="Butt">

            </div>
        </div> <!-- cd-panel-content -->
    </div> <!-- cd-panel-container -->
</div> <!-- cd-panel -->


<script>


    function next() {
        var item = $('#' + loader.currentPage);
        var parent = $(item).data('parent');
        var pos = $(item).data('pos');
        if (pos < allPages[parent].length - 1) {
            goToPage(allPages[parent][pos + 1]);
        }
    }

    function previous() {
        var item = $('#' + loader.currentPage);
        var parent = $(item).data('parent');
        var pos = $(item).data('pos');
        if (pos > 0) {
            goToPage(allPages[parent][pos - 1]);
        }
    }

    function goToPreviousPage() {
        goToPage(loader.previousPage);
    }


    function goToPage(id) {

        loader.goToPage(id);
        //loader.setCurrentPage(id);
    }

    window.onhashchange = function () {
        goToPage(window.location.hash.substring(1));
    };

    function loadPage(pageName, element, index, vindex) {
        $.ajax({
            type: "POST",
            url: "/loadPage",
            data: {name: pageName},
            async: false,
            success: function (data) {
                $(element).append("<div id='" + pageName + "' data-ownId='" + pageName + "' " +
                        "data-pos='" + index + "' data-vpos='" + vindex + "' " +
                        "data-parent='" + element.substring(1) + "'>" + data + "</div>");
            }
        });
    }


    var allSections = ['abovePages', 'createTicket', /*'acceptTicket',*/ 'confirmTicket', 'driverFlow'];

    var all = ["_accSetting", "_contact", "_history", "_passwordRecovery", "_homePage", "_shopping", "_checkout", "_login",
        "_rating", "_passwordReset", "_signUp", "_tickets", "_driverList2", '_congrats', "_yourDeliveries"];

    var allGlyphs = ["glyphicon glyphicon-cog", "", "", "glyphicon glyphicon-wrench", "glyphicon glyphicon-home",
        "", "glyphicon glyphicon-check", "glyphicon glyphicon-log-in", "glyphicon glyphicon-signal",
        "glyphicon glyphicon-repeat",
        "glyphicon glyphicon-plus-sign", "", "", ""];

    var pageNames = ["Setting", "Contact", "History", "Password Recovery", "Home", "Shopping", "Checkout", "Login",
        "Rating", "Password Reset", "Sign Up", "Tickets", "Driver List", 'Congrats', "Your Deliveries"];

    var allPages = {
        abovePages: ["_accSetting", "_contact", "_history", "_passwordRecovery" /*,"_passwordReset" ",_signUp", "_login"*/],
        createTicket: ["_homePage", "_shopping", "_checkout", "_login"/*, "_submitted"*/],
        /*acceptTicket: ['_acceptTicket', '_paid'],*/
        /*acceptTicket: ['_cancelTicket','_cancelled'],*/
        confirmTicket: [/*'_confirmTicket',*/ "_rating", /*'_ticketClosed',*/"_passwordReset", "_signUp"],
        driverFlow: ['_tickets', '_driverList', /*'_confirmCompletion', '_completeTicket', '_rating',*/ '_congrats']
    };

    loadPage("_driverTickets", '#driverTickets');
    loadPage("_userTickets", '#userTickets');


    /*
     TODO:
     Each page MUST specify function to send/received data, or null

     Each page will call goToPage onclick to go to the correct page



     */


    //Backend loads/stores ticket into page objects:
    function loadTicket() {

    }
    function saveTicket() {

    }
    var ticketPrototype = {
        ticket: {
            id: "",
            state: "",
            store: "",
            user: {
                id: "",
                contact: "",
                rating: ""
            },
            driver: {
                id: "",
                rating: ""
            },
            list: [],
            options: {},
            checkoff: []
        }
    };


    var loader = {
        isDriver: false,
        isLoggedIn: false,
        userId: "",
        pageCount: 0,
        previousPage: "",
        currentPage: "",
        currentPageObject: {
            getData: null,
            loadData: null,
            data: null
        },
        goToPage(id){
            var item = $('#' + id);
            $("#page-content").css('transform',
                    'translate(-' + $(item).data("pos") * 100 + '%, -' + $(item).data("vpos") * 100 + '%)')
        },
        setCurrentPage: function (page) {
            loader.pageCount++;
            var oldPage = loader.currentPage;
            loader.currentPage = page;
            if (loader.currentPageObject.getData != null) {
                loader.currentPageObject.data = loader.currentPageObject.getData();
            }
            else {
                loader.currentPageObject.data = null;
            }

            $.post("/changePage", {
                data: {
                    pageCount: loader.pageCount,
                    newPage: page,
                    oldPage: oldPage,
                    oldData: loader.currentPageObject.data
                }
            }, function (newPageData) {
                loader.goToPage(page);
                loader.previousPage = oldPage;
                loader.currentPageObject = loader[page];
                if (loader.currentPageObject.loadData != null) {
                    loader.currentPageObject.loadData(newPageData);
                }
            });
        },

        //Saves current active ticket (if any), then fetches new one and loads page data corresponding to ticket status in back end store
        getTicket: function (ticketId, state, store) {
            if (arguments.length < 3) {
                store = null;
            }
            if (state != "accepted" || loader.isDriver) {
                $.post("/getTicket", {
                    data: {
                        id: ticketId,
                        store: store
                    }
                }, function () {
                    if (loader.isDriver) {
                        switch (state) {
                            case "accepted" :
                                goToPage("_driverList");
                                break;
                            case "shopped":
                                goToPage("_completeTicket");
                                break;
                            case "" :
                        }
                    }
                    else {
                        switch (state) {
                            case "draft" :
                                goToPage("_shopping");
                                break;
                            case "pending":
                                goToPage("_cancelTicket");
                                break;
                            case "shopped":
                                goToPage("_acceptTicket");
                                break;
                        }
                    }
                });
            }
        },
        currentPageChanged: function () {
            //Submit data
            //Throttle.
        },
        sendData: function () { //Gets data from page and sends to server for update. Server will send back version num
            if (loader.currentPageObject.getData != null) {
                loader.currentPageObject.data = loader.currentPageObject.getData();
                $.post("/sendData", {
                    data: {
                        page: loader.currentPage,
                        data: loader.currentPageObject.data
                    }
                }, function (resp) {
                    if (loader.currentPageObject.version < resp) {
                        loader.currentPageObject.version = resp;
                    }
                });
            }
        },
        loadData: function () { //Gets data from server to load page with
            if (loader.currentPageObject.loadData != null) {
                $.post("/loadData" + loader.currentPage, {
                    data: loader.currentPageObject.version
                }, function (resp) {
                    if (data != null) {
                        loader.currentPageObject.data = resp.data;
                        loader.currentPageObject.version = resp.version;
                        loader.currentPageObject.loadData();
                    }
                });
            }
        },
        //set to run every second elsewhere
        getUpdates: function () {
            $.post("/getUpdates", {
                data: {
                    pageCount: loader.pageCount,
                    page: loader.currentPage
                }
            }, function (resp) {
                if (resp.i)


                //Change page if page is newer
                    if (resp.pageCount > loader.pageCount) {
                        loader.previousPage = resp.previousPage;
                        loader.currentPage = resp.currentPage;
                        loader.currentPageObject = loader[resp.currentPage];
                        loader.currentPageObject.version = resp.version;
                        if (loader.currentPageObject.loadData != null) {
                            loader.currentPageObject.loadData(resp.data);
                        }
                    }
                    //Update page if on same page and new version
                    else if (resp.pageCount == loader.pageCount) {
                        if (resp.version > loader.currentPageObject.version) {
                            if (loader.currentPageObject.loadData != null) {
                                loader.currentPageObject.loadData(resp.data);
                            }
                        }
                    }
                    else {
                        //do nothing since this local copy is newer
                    }

            });
        },

        login: function (data) {
            alert(data);
            document.getElementById("index_user-name").innerHTML = data.full_name;
            goToPreviousPage();
        },
        logout: function () {
            //TODO: delete cookie and refresh page
        },
        switchToDriver: function () {

        },
        switchToShopper: function () {

        }
    };


    /*
     Each page that needs like sync (edit ticket pages and stateless pages) has:
     data:
     version:
     getData: packages page data.
     loadData: loads data package
     Otherwise it is a missing property; the other pages load data through their own ajax(?)
     */

    function pageInit() {

        //TODO: check for coookie to see if logged in
        var id;

        $.ajax({
            type: "POST",
            url: "/init",
            data: {
                userId: loader.userId //"" or valid user id string
            },
            success: function (resp) {
                //If has existing session, load it!
                if (resp != "none") {
                    loader.isDriver = resp.isDriver;
                    loader.userId = resp.userId;
                    loader.pageCount = resp.pageCount;
                    loader.previousPage = resp.previousPage;
                    loader.currentPage = resp.currentPage;
                    loader.currentPageObject = loader[resp.currentPage];

                    loader.currentPageObject.version = resp.version;
                    if (loader.currentPageObject.loadData != null) {
                        loader.currentPageObject.loadData(resp.data);
                    }

                    loader.goToPage(resp.currentPage);
                }

                window.setInterval(loader.getUpdates, 1000);
            }
        });
    }

//    $(document).ready(function () {
//        pageInit();
//        var i;
//        var whichid;
//        var glyph;
//        var name;
//        for (var j = 0; j < allSections.length; j++) {
//            var sectionName = allSections[j];
//            var section = allPages[sectionName];
//            for (i = 0; i < section.length; i++) {
//                whichid = section[i];
//                for (var k = 0; k < all.length; k++) {
//                    if (whichid == all[k]) {
//                        glyph = allGlyphs[k];
//                        name = pageNames[k];
//                        break;
//                    }
//                }
//                loadPage(whichid, '#' + sectionName, i, j);
//                var clickVal = "onclick=\"goToPage('" + whichid + "');\"";
//                $("#Butt").append("<div " + clickVal + " > <span class= '" + glyph + "'></span> " + name + "   </div>");
//            }
//        }
//    });


    jQuery(document).ready(function ($) {
        $('#open-menu-drawer').on('click', function (event) {
            $('#menu-drawer').addClass('is-visible');
        });
        $('#menu-drawer').on('click', function (event) {
            if ($(event.target).is('.cd-panel') || $(event.target).is('.cd-panel-close')) {
                $('#menu-drawer').removeClass('is-visible');
            }
        });
    });
</script>
<script type="text/javascript" src="/js/_index.js"></script>

</body>
</html>

